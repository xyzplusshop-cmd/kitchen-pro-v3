generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  password  String
  name      String?
  role      String    @default("USER") // ADMIN, USER
  projects  Project[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

enum MaterialType {
  BOARD
  EDGE
  HARDWARE
}

model Project {
  id             String   @id @default(uuid())
  name           String
  clientName     String?
  userId         String
  user           User     @relation(fields: [userId], references: [id])
  linearLength   Float    // Longitud total de la cocina lineal
  openingSystem  String   @default("HANDLE") // HANDLE, GOLA, PUSH
  defaultEdgeId  String?
  thumbnail      String?  // URL o Base64 de la previsualización
  config         Json?    // Alturas, profundidades, tipo de puerta
  codigo         String?  @unique // C-2025-001
  
  // Thickness Management (Source of Truth)
  carcassThickness Int    @default(18)  // 15mm o 18mm - Estructura
  frontsThickness  Int    @default(18)  // 15mm, 18mm, 22mm - Puertas/Cajones
  
  // Back Panel Mounting Logic
  backMountingType String   @default("NAILED") // NAILED, GROOVED
  grooveDepth      Float    @default(9)
  rearGap          Float    @default(18)

  modules        Module[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model HardwareItem {
  id              String   @id @default(cuid())
  name            String
  category        String   // BISAGRA, CORREDERA, OTROS
  compatibility   String[] // FULL_OVERLAY, HALF_OVERLAY, INSET, STANDARD, etc.
  discountRules   Json     // side_clearance, depth_clearance, etc.
  price           Float    @default(0)
  unitCost        Float    @default(0) // Purchase cost
  provider        String?
  brand           String?
  codigo          String?  @unique // HRD-001
  openingDegree   Int?     // Grados de apertura (ej: 110, 155, 170)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model DrawerSystem {
  id                  String   @id @default(cuid())
  name                String
  brand               String?
  isMetal             Boolean  @default(false)
  slideClearance      Float    @default(12.7)
  bottomConstruction  String   @default("RANURADO") // RANURADO, CLAVADO
  backendClearance    Float    @default(10)
  price               Float    @default(0)
  unitCost            Float    @default(0) // Purchase cost
  provider            String?
  codigo              String?  @unique // DRW-001
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model ModuleTemplate {
  id              String   @id @default(cuid())
  modelo          String   // Código del modelo (ej: MA-01, MB-02, DT-01)
  nombre          String   // Nombre descriptivo
  zona            String   // WALL, BASE, TOWER, ISLAND  
  tipoApertura    String?  // PUSH, GOLA, JALADORES (se define aquí)
  
  // External Dimensions (User Input in Catalog Wizard)
  externalWidth   Float?   // Ancho total externo
  externalHeight  Float?   // Alto total externo
  externalDepth   Float?   // Profundidad total externa
  
  // Reference Thickness (Solo para cálculos en catálogo)
  referenceThickness Int   @default(18)  // 15mm o 18mm
  
  piezas          Json     // Estructura JSON con todas las piezas y dimensiones
  
  // Piece Templates with Formulas (for auto-calculation)
  pieceTemplates  Json?    // Templates con fórmulas para calcular dimensiones
  
  // Stretcher Configuration Defaults
  hasTopStretcher    Boolean? @default(false)
  hasBottomStretcher Boolean? @default(false)
  hasFrontStretcher  Boolean? @default(false)
  hasBackPanel       Boolean? @default(true)
  
  // Back Panel Mounting Logic
  backMountingType String   @default("NAILED") // NAILED, GROOVED
  grooveDepth      Float    @default(9)
  rearGap          Float    @default(18)

  thumbnail       String?
  descripcion     String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}


model LegSystem {
  id        String   @id @default(cuid())
  name      String
  height    Float
  price     Float
  unitCost  Float    @default(0) // Purchase cost
  provider  String?
  brand     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Tool {
  id        String   @id @default(cuid())
  name      String
  codigo    String   @unique // TOL-001
  brand     String?
  price     Float    @default(0)
  unitCost  Float    @default(0) // Purchase cost
  provider  String?
  stock     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Accessory {
  id        String   @id @default(cuid())
  name      String
  codigo    String   @unique // ACC-001
  price     Float    @default(0)
  unitCost  Float    @default(0) // Purchase cost
  provider  String?
  stock     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Module {
  id            String   @id @default(uuid())
  projectId     String
  project       Project  @relation(fields: [projectId], references: [id])
  type          String   // BASE, WALL, TALL, SINK_BASE, DRAWER, etc.
  category      String   @default("BASE") // TOWER, BASE, WALL
  width         Float
  isFixed       Boolean  @default(false)
  doorCount     Int      @default(0)
  drawerCount   Int      @default(0)
  hingeType     String   @default("Estándar")
  sliderType    String   @default("Estándar")
  hingeId       String?  // ID del herraje inteligente seleccionado
  sliderId      String?  // ID de la corredera inteligente seleccionada
  drawerSystemId String? // ID del sistema de cajón seleccionado
  height        Float    @default(720)
  depth         Float    @default(560)
  openingSystem String?
  codigo        String?  // MOD-BASE-001 (Unique per project)
  templateId    String?  // Reference to ModuleTemplate
  legSystemId   String?  // Reference to LegSystem
  customPieces  Json?    // Custom piece edits (Stage 3)
  calculationRules Json? // Applied calculation rules
  
  // Stretchers System (Economic Furniture)
  hasTopStretcher    Boolean? @default(false)
  hasBottomStretcher Boolean? @default(false)
  hasFrontStretcher  Boolean? @default(false)
  hasBackPanel       Boolean? @default(true)
  
  // Back Panel Mounting Logic (Overrides)
  backMountingType String?  // NAILED, GROOVED, INSET
  grooveDepth      Float?
  rearGap          Float?

  pieces        Piece[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Piece {
  id          String   @id @default(uuid())
  moduleId    String
  module      Module   @relation(fields: [moduleId], references: [id])
  name        String
  finalWidth  Float
  finalHeight Float
  cutWidth    Float
  cutHeight   Float
  codigo      String?  // PZA-LAT-001
  materialId  String?
  material    Material? @relation("PieceMaterial", fields: [materialId], references: [id])
  
  // Cantos por lado (relacionados con Material de tipo EDGE)
  edgeL1Id    String?
  edgeL1      Material? @relation("PieceEdgeL1", fields: [edgeL1Id], references: [id])
  edgeL2Id    String?
  edgeL2      Material? @relation("PieceEdgeL2", fields: [edgeL2Id], references: [id])
  edgeA1Id    String?
  edgeA1      Material? @relation("PieceEdgeA1", fields: [edgeA1Id], references: [id])
  edgeA2Id    String?
  edgeA2      Material? @relation("PieceEdgeA2", fields: [edgeA2Id], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Material {
  id          String   @id @default(uuid())
  name        String
  type        MaterialType
  category    String   // ej. "Melamina 18mm", "PVC 0.45mm"
  thickness   Float    // Crucial para cálculos de descuento
  colorHex    String?  // Para representación visual en 3D/UI
  isDefault   Boolean  @default(false)
  width       Float?   @default(2440) // Ancho standard en mm
  height      Float?   @default(1830) // Alto standard en mm
  cost        Float    @default(0) // Still use cost but we can map it as unitCost in code
  unitCost    Float    @default(0) // Explicit purchase cost
  provider    String?
  codigo      String?  @unique
  
  // Relations
  pieces      Piece[]  @relation("PieceMaterial")
  piecesL1    Piece[]  @relation("PieceEdgeL1")
  piecesL2    Piece[]  @relation("PieceEdgeL2")
  piecesA1    Piece[]  @relation("PieceEdgeA1")
  piecesA2    Piece[]  @relation("PieceEdgeA2")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum MachineType {
  CUTTING
  EDGE_BANDING
  CNC
}

model Machine {
  id                  String      @id @default(cuid())
  name                String
  type                MachineType
  powerConsumptionKw  Float       @default(0) // Energy usage in kW
  operationCostPerHour Float      @default(0) // Fixed maintenance/depreciation cost
  processingSpeed     Float       @default(0) // Meters per minute
  provider            String?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
}

model GlobalConfig {
  id                String   @id @default("singleton")
  energyPricePerKwh Float    @default(0) // Local energy cost
  consumablesRates  Json?    // Screws, glue, dowels pricing
  profitMargin      Float    @default(30) // Default sales margin (%)
  updatedAt         DateTime @updatedAt
}
