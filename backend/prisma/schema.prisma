generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  password  String
  name      String?
  role      String    @default("USER") // ADMIN, USER
  projects  Project[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Project {
  id             String   @id @default(uuid())
  name           String
  clientName     String?
  userId         String
  user           User     @relation(fields: [userId], references: [id])
  linearLength   Float    // Longitud total de la cocina lineal
  openingSystem  String   @default("HANDLE") // HANDLE, GOLA, PUSH
  defaultEdgeId  String?
  thumbnail      String?  // URL o Base64 de la previsualización
  config         Json?    // Alturas, profundidades, tipo de puerta
  modules        Module[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model HardwareItem {
  id              String   @id @default(cuid())
  name            String
  category        String   // BISAGRA, CORREDERA, OTROS
  compatibility   String[] // FULL_OVERLAY, HALF_OVERLAY, INSET, STANDARD, etc.
  discountRules   Json     // side_clearance, depth_clearance, etc.
  price           Float    @default(0)
  brand           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model DrawerSystem {
  id                  String   @id @default(cuid())
  name                String
  brand               String?
  isMetal             Boolean  @default(false)
  slideClearance      Float    @default(12.7)
  bottomConstruction  String   @default("RANURADO") // RANURADO, CLAVADO
  backendClearance    Float    @default(10)
  price               Float    @default(0)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model ModuleTemplate {
  id              String   @id @default(cuid())
  modelo          String   // Código del modelo (ej: MA-01, MB-02, DT-01)
  nombre          String   // Nombre descriptivo
  zona            String   // WALL, BASE, TOWER, ISLAND
  tipoApertura    String?  // PUSH, GOLA, JALADORES (se define aquí)
  piezas          Json     // Estructura JSON con todas las piezas y dimensiones
  thumbnail       String?
  descripcion     String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}


model LegSystem {
  id        String   @id @default(cuid())
  name      String
  height    Float
  price     Float
  brand     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Module {
  id            String   @id @default(uuid())
  projectId     String
  project       Project  @relation(fields: [projectId], references: [id])
  type          String   // BASE, WALL, TALL, SINK_BASE, DRAWER, etc.
  category      String   @default("BASE") // TOWER, BASE, WALL
  width         Float
  isFixed       Boolean  @default(false)
  doorCount     Int      @default(0)
  drawerCount   Int      @default(0)
  hingeType     String   @default("Estándar")
  sliderType    String   @default("Estándar")
  hingeId       String?  // ID del herraje inteligente seleccionado
  sliderId      String?  // ID de la corredera inteligente seleccionada
  drawerSystemId String? // ID del sistema de cajón seleccionado
  height        Float    @default(720)
  depth         Float    @default(560)
  openingSystem String?
  templateId    String?  // Reference to ModuleTemplate
  legSystemId   String?  // Reference to LegSystem
  customPieces  Json?    // Custom piece edits (Stage 3)
  calculationRules Json? // Applied calculation rules
  pieces        Piece[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Piece {
  id          String   @id @default(uuid())
  moduleId    String
  module      Module   @relation(fields: [moduleId], references: [id])
  name        String
  finalWidth  Float
  finalHeight Float
  cutWidth    Float
  cutHeight   Float
  materialId  String?
  material    Material? @relation(fields: [materialId], references: [id])
  
  // Cantos por lado (IDs de EdgeBand)
  edgeTopId    String?
  edgeBottomId String?
  edgeLeftId   String?
  edgeRightId  String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Material {
  id        String   @id @default(uuid())
  name      String
  thickness Float
  cost      Float
  pieces    Piece[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EdgeBand {
  id        String   @id @default(uuid())
  name      String
  thickness Float
  cost      Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
